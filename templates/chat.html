{% extends 'base.html' %}
{% block content %}
<!-- Adding Quill Styles and Emoji Plugin -->
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-emoji/dist/quill-emoji.css">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-emoji/dist/quill-emoji.min.js"></script>

<!-- <div class="chat-title">
    <h1>Secure Chat</h1>
    <button type="button" name="leave" id="leave-btn" onclick="leaveRoom()">
        Leave Room
    </button>
</div> -->
<!-- <div class="chat-box">
    <h3>Welcome {{username}} to the Chat Room!</h3>
    <div class="messages" id="messages"></div>
    
    <div class="input-text">
        <div id="editor-container"></div>
        <button type="button" name="send" id="send-btn" onclick="sendMessage()">
            Send
        </button>
    </div>
</div> -->
<div class="chat-container">
    <div class="sidebar">
        <h3>Users</h3>
        <form id="chat-selection">
            <div id="user-list"></div>
            <button type="button" onclick="createChat()">Start Chat</button>
        </form>

        <h3>Active Chats</h3>
        <div id="active-chats"></div>
    </div>

    <div class="chat-box">
        <h3 id="chat-header">Select a chat</h3>
        <div class="messages" id="messages"></div>

        <div class="input-text">
            <!-- Quill Editor -->
            <div id="editor-container"></div>
            <button type="button" id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    
    let ws;
    let username = "{{ username }}";
    let currentChatId = null;
    let activeChats = new Set(); 
    
    function connectWebSocket() {
        ws = new WebSocket("wss://" + window.location.hostname + ":8765");

        ws.onopen = () => {
            console.log("WebSocket Connection open from client. Sending username :",username)
            // ws.send(username);  //Sending username first for identification
            ws.send(JSON.stringify({ "username": username }));
        }

        //Listening for message event sent from web socket server and displaying in our chat-box
        ws.onmessage = (event) => {
            console.log("Received message from WS Server. message :",event.data)
            // showMessage(event.data);
            let data = JSON.parse(event.data);

            if (data.user_list) {
                updateUserList(data.user_list);
            }
            else
            {
                showMessage(event.data);
            }
        };

        window.addEventListener("beforeunload", () => {
            ws.close();  // Explicitly close WebSocket when the user closes tab
        });
        
        ws.onclose = (event) => {
            console.log("WebSocket closed.");
    
            //Attempt to reconnect if it was an unexpected disconnection
            if (!event.wasClean) {
                console.log("Reconnecting...");
                setTimeout(connectWebSocket, 3000); // Auto-reconnect after 3 seconds if connection is lost
            }
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            ws.close();
        };
    }

    connectWebSocket()

    //Displaying online connected clients available for chat
    function updateUserList(users) {
        let userListDiv = document.getElementById("user-list");
        userListDiv.innerHTML = users
            .filter(u => u !== username)
            .map(u => `<label><input type="checkbox" value="${u}"> ${u}</label><br>`)
            .join("");
    }

    //Displaying received message in our chat-box div
    const messages = document.getElementById("messages")
    const showMessage = (msg) =>{
        const sanitizedMsg = DOMPurify.sanitize(msg);
        let usrMsgSplit = sanitizedMsg.split(":")
        const texts = `
        <div> 
            <span>
                <strong>${usrMsgSplit[0]}</strong>: ${usrMsgSplit.slice(1).join(":")}
            </span>
        </div>
        `;
        messages.innerHTML += texts;
    };

    //Initializing Quill with text formatting for bold, italics, underline, lists, links, Emoji
    const quill = new Quill("#editor-container", {
        theme: "snow",
        placeholder: "Enter Message...",
        modules: {
            toolbar: [
                ["bold", "italic", "underline", "strike"],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ list: "ordered" }, { list: "bullet" }],
                [{ 'color': [] }, { 'background': [] }], // dropdown with defaults from theme
                ["link"],
                ["emoji"] //Adds emoji picker button
            ],
            "emoji-toolbar": true,
            "emoji-shortname": true
        }
    });

    //Sending formatted message to the websocket server
    const sendMessage = () => {
        let message = quill.root.innerHTML.trim();
        if (message === "<p><br></p>" || message === "") return;

        let sanitizedMessage = DOMPurify.sanitize(message);

        // Convert paragraph breaks into spaces after sanitization
        sanitizedMessage = sanitizedMessage.replace(/<\/p><p>/g, " ")
                                           .replace(/<p>|<\/p>/g, "")
                                           .replace(/<br>/g, " ");

        console.log("Sending sanitized message to WS Server:", sanitizedMessage);
        ws.send(sanitizedMessage);

        quill.root.innerHTML = "";
    };

    // Event listener to send message on 'Enter' key
    quill.root.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    //Handler for "Leave Room" button
    const leaveRoom = () => {
        console.log("Leaving room...");
        ws.close();
        window.location.href = "/leave";  //Call Backend for redirection
    };

</script>
{% endblock %}